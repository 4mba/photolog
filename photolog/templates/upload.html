{% extends "layout.html" %}
{% block title %}Upload{% endblock %}
{% block head %}
  {{ super() }}
{% endblock %}

<!-- File Upload Form -->
{% block content %}

  <div class="container span12">
		
	    <form id="upload" name="upload" class="form-horizontal span12" method='POST' action='/photo/upload' enctype='multipart/form-data' runat="server">
	    	<div class="row-fluid span12">
		    	<div class="span4">
				    <div class="fileupload fileupload-new" data-provides="fileupload">
					    <div class="fileupload-new thumbnail span6" >
					        <p>
    					    	<img id="preview" class="span12" src="http://www.placehold.it/200x150/EFEFEF/AAAAAA&text=no+image" />
					    	</p>
					    </div>
				
					    <div>
					    	<!--
						    <span class="btn btn-file">
						    	<span class="fileupload-new">Select image</span>
						    	<span class="fileupload-exists">Change</span>
							    <a href="#" class="btn fileupload-exists" data-dismiss="fileupload">Remove</a>
							</span>
						    -->
						    <p>
					    	<input id="photo" type="file" class="btn-file input-small span12" name="upload" />
                            </p>
                            <p>
                            <input type="text" class="input-large span12" name="tag" placeholder="Tag">
                            </p>
                            <p>
	                            <textarea class="input-block-level" rows="3" name="memo" placeholder="memo"></textarea>
                            </p>
                            <P>
                            <button type="submit" name="submit" class="btn btn-medium btn-block btn-primary">저장하기</button>
                            </P>
					    </div>
					  </div>
				</div> <!-- end of row-fluid span4 -->
				<div class="span8 well" >
    
                    <div class="span12" >

                        <div class="input-append">
                            <p>
                                <input class="span12" id="address" name="address" type="text" placeholder="지역이름">
                                <button id="address-search" class="btn btn-success" type="button">찾기</button>
                            </p>
                        </div>

                        <div id="photo-location" class="photo_location span12">
                        </div>
              		</div>
				</div> <!-- end of row-fluid span9 -->
		   </div> <!-- end of row-fluid -->
		   <div class="container">
                <input type="hidden" name="date" value="">
                <input type="hidden" name="lat" value="">
                <input type="hidden" name="lng" value="">
                
		   </div>
	    </form>    
	    
	</div>

	<script type="text/javascript">
	
        var lat; // GPSLatitude
        var lng; // GPSLongitude
        var date;// DateTimeOriginal


        // 기본위치로 서울 덕수궁으로 표시한다.
        map = new GMaps({
          zoom : 17,
          div: '#photo-location',
          lat: 37.565467,
          lng: 126.975431 
        });

        
        // 검색된 위치 업데이트
        $('#address-search').click(function(e){
            e.preventDefault();
            
            GMaps.geocode({
                address: $('#address').val().trim(),
                callback: function(results, status){
                    if(status=='OK'){
                        var latlng = results[0].geometry.location;
                        map.setCenter(latlng.lat(), latlng.lng());
                        map.addMarker({
                            lat: latlng.lat(),
                            lng: latlng.lng()
                        });
                        
                        lat = latlng.lat();
                        lng = latlng.lng();

                        $('[name=lat]').val(lat);
                        $('[name=lng]').val(lng);
                        
                        alert("lat:"+lat);
                        alert("lat:"+ $('[name=lat]').val());

                    }
                }
            });
        });


        $('#upload').submit(function(e){
            
            
            if($('[name=tag]').val() == "" || $('[name=memo]').val() == "") {
                bootbox.alert("태그와 메모를 남겨 주세요");
                return false;
            }

            if($('input[type=file]').val() == "") {
                bootbox.alert("사진파일을 선택해주세요");
                return false;
            }
            
            if($('[name=lat]').val() == "" || $('[name=lng]').val() == "") {
                bootbox.alert("위치정보를 입력해주세요");
                return false;
            }
            
        });

      

		// reference code : http://jsfiddle.net/LvsYc/ 
        function readURL(input) {
        if (input.files && input.files[0]) {
            var reader = new FileReader();
            
            reader.onload = function (e) {
                $('#preview').attr('src', e.target.result);
            }
                reader.readAsDataURL(input.files[0]);
            }
        }


		
		// When photo uploaded
		$("#photo").change(function() {

            readURL(this);
		    
		    var file = this.files[0];
		    fr   = new FileReader;

		    fr.onloadend = function() {
		        
                // Reference code : http://jsfiddle.net/xQnMd/1/
		        var exif = EXIF.readFromBinaryFile(new BinaryFile(this.result));

                
                // exif에서 GPS정보를 가져올 수 없는 경우
                if(exif.GPSLatitude == undefined) {
                    bootbox.alert("사진에서 GPS정보를 가져올 수 없습니다. 위치를 검색해 주세요");
                }
                // exif에서 GPS정보를 가져올 수 있는 경우
                else {
                    lat = toDecimal(exif.GPSLatitude, exif.GPSLatitudeRef);
                    lng = toDecimal(exif.GPSLongitude, exif.GPSLongitudeRef);
                    date = exif.DateTimeOriginal;
                    
                    $('[name=date]').val(date);
                    $('[name=lat]').val(lat);
                    $('[name=lng]').val(lng);

                    // update location
                    map.setCenter(lat, lng)
                    
                    map.drawOverlay({
                        lat: lat,
                        lng: lng,
                        content: '<div class="overlay">Here!<div class="overlay_arrow above"></div></div>',
                        verticalAlign: 'top',
                        horizontalAlign: 'center'
                    });
                }


		    };
		    
		    fr.readAsBinaryString(file);
		});
		


        function toDecimal(gps_src, gps_ref){

            var temp_array="";
            temp_array = gps_src.toString();
            temp_array = temp_array.split(",");

            deg = temp_array[0];
            min = temp_array[1];
            sec = temp_array[2];
            ref = gps_ref;
                        
            return ConvertDMSToDD(deg, min, sec, ref);
            // return parseFloat(translator(deg, min, sec, ref)).toFixed(6);
        }

 
        function ConvertDMSToDD(days, minutes, seconds, direction) {

            var dd = parseFloat(days) + parseFloat(minutes/60) + parseFloat(seconds/(60*60));
        
            if (direction == "S" || direction == "W") {
                dd = dd * -1;
            } // Don't do anything for N or E
            
            return dd;
        }


 
	</script>
{% endblock %}
