{% extends "layout.html" %}
{% block title %}Upload{% endblock %}
{% block head %}
  {{ super() }}
{% endblock %}

<!-- File Upload Form -->
{% block content %}

  <div class="container well">
		
	    <form name="upload" class="form-horizontal" method='POST' action='/photo/upload_photo' enctype='multipart/form-data' runat="server">
	    	<div class="row-fluid">
		    	<div class="span4">
				    <div class="fileupload fileupload-new" data-provides="fileupload">
					    <div class="fileupload-new thumbnail" style="width: 200px; height: 150px;">
					        <p>
    					    	<img id="preview" src="http://www.placehold.it/200x150/EFEFEF/AAAAAA&text=no+image" />
					    	</p>
					    </div>
				
					    <div class="fileupload-preview fileupload-exists thumbnail" 
					                style="max-width: 200px; max-height: 150px; line-height: 20px;">
					    </div>
				
					    <div>
					    	<!--
						    <span class="btn btn-file">
						    	<span class="fileupload-new">Select image</span>
						    	<span class="fileupload-exists">Change</span>
							    <a href="#" class="btn fileupload-exists" data-dismiss="fileupload">Remove</a>
							</span>
						    -->
					    	<input id="photo" type="file" class="btn-file input-small" name="upload" />
					    </div>
					  </div>
				    <div class="container">
				    	<p>
							<input type="text" class="input-large" name="tag" placeholder="Tag">
					    </p>
				    	<p>
						    <textarea class="input-large" rows="3" name="memo" placeholder="memo"></textarea>
					    </p>
					    <p>
	              			<button type="submit" name="submit" class="btn">upload</button>
              			</p>
              		</div>
				</div> <!-- end of row-fluid span4 -->
				<div class="span8">
				    <div class="container well span8">
				    	<p>
				    		&nbsp; <i class="icon-map-marker"></i> Show Google Map
                            <div id="map" class="map">
                                
                            </div>
              			</p>
              		</div>
				</div> <!-- end of row-fluid span9 -->
		   </div> <!-- end of row-fluid -->
		   <div class="container">
                <input type="hidden" name="date" value="">
                <input type="hidden" name="lat" value="">
                <input type="hidden" name="lng" value="">
                
		   </div>
	    </form>    
	    
	</div>

	<script type="text/javascript">
	

		// reference code : http://jsfiddle.net/LvsYc/ 
        function readURL(input) {
        if (input.files && input.files[0]) {
            var reader = new FileReader();
            
            reader.onload = function (e) {
                $('#preview').attr('src', e.target.result);
                $("#preview").css("width","200px");
                $("#preview").css("height","150px");
            }
                reader.readAsDataURL(input.files[0]);
            }
        }
		
		// When photo uploaded
		$("#photo").change(function() {
		    
            readURL(this);
		    
		    var file = this.files[0];
		    fr   = new FileReader;
		    fr.onloadend = function() {
		        
                // Reference code : http://jsfiddle.net/xQnMd/1/
		        var exif = EXIF.readFromBinaryFile(new BinaryFile(this.result));
                
                lat = toDecimal(exif.GPSLatitude, exif.GPSLatitudeRef);
                lng = toDecimal(exif.GPSLongitude, exif.GPSLongitudeRef);
                
             
                document.forms['upload'].date.value = exif.DateTimeOriginal;
                document.forms['upload'].lat.value = lat;
                document.forms['upload'].lng.value = lng;
                
                
                map = new GMaps({
                  zoom : 17,
                  div: '#map',
                  lat: lat,
                  lng: lng 
                });
                
                
                map.drawOverlay({
                    lat: map.getCenter().lat(),
                    lng: map.getCenter().lng(),
                    content: '<div class="overlay">Here!<div class="overlay_arrow above"></div></div>',
                    verticalAlign: 'top',
                    horizontalAlign: 'center'
                });


		    };
		    
		    fr.readAsBinaryString(file);
		});
		


        function toDecimal(gps_src, gps_ref){

            var temp_array="";
            temp_array = gps_src.toString();
            temp_array = temp_array.split(",");

            deg = temp_array[0];
            min = temp_array[1];
            sec = temp_array[2];
            ref = gps_ref;
                        
            return ConvertDMSToDD(deg, min, sec, ref);
            // return parseFloat(translator(deg, min, sec, ref)).toFixed(6);
        }

 
        function ConvertDMSToDD(days, minutes, seconds, direction) {

            var dd = parseFloat(days) + parseFloat(minutes/60) + parseFloat(seconds/(60*60));
        
            if (direction == "S" || direction == "W") {
                dd = dd * -1;
            } // Don't do anything for N or E
            
            return dd;
        }


 
	</script>
{% endblock %}
